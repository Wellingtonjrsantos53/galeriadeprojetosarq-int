<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria de Portfólio - Projetos Arq. e Int.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ATUALIZADO: Inclui 'where' e outros comandos Firestore
        import { getFirestore, onSnapshot, collection, query, where, doc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDUQq0J96QQpGSbEXrnLjnsSCSGTzQlVns",
            authDomain: "galeria-do-site-duplicado.firebaseapp.com",
            projectId: "galeria-do-site-duplicado",
            storageBucket: "galeria-do-site-duplicado.firebasestorage.app",
            messagingSenderId: "717918810787",
            appId: "1:717918810787:web:01c7cbc1a1b7b880bb8516",
            measurementId: "G-ZFNYWV4BFB"
        };
        
        // --- Firebase Initialization ---
        let db, auth;
        let currentCarouselPhotos = [];
        let currentImageIndex = 0;

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                await signInAnonymously(auth);
            }
            setupFilteredGalleryListener();
        });

        // --- FUNÇÕES DE UI ---
        
        const showMessage = (message, type = 'info') => { 
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-blue-500');
            messageBox.classList.add('flex', type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500');
            messageBox.classList.remove('opacity-0');
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 500);
            }, 3000);
        };
        
        const formatComodosList = (listaComodos) => { 
            if (!listaComodos || listaComodos.length === 0) return 'Nenhum cômodo listado';
            return listaComodos.map(c => c.nome).join(', ');
        };
        
        const generateDisplayStars = (rating) => { 
            const roundedRating = Math.round(rating * 2) / 2;
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= roundedRating) {
                    stars += `<svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.487 7.71l6.561-.955L10 1l2.952 5.755 6.561.955-4.758 4.835 1.123 6.545z"/></svg>`;
                } else if (i - 0.5 === roundedRating) {
                    stars += `<svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.487 7.71l6.561-.955L10 1l2.952 5.755 6.561.955-4.758 4.835 1.123 6.545z" clip-rule="evenodd" fill-rule="evenodd"/><path d="M10 1l-2.952 5.755-6.561.955 4.758 4.835-1.123 6.545L10 15v-14z" fill="white"/></svg>`;
                } else {
                    stars += `<svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.487 7.71l6.561-.955L10 1l2.952 5.755 6.561.955-4.758 4.835 1.123 6.545z"/></svg>`;
                }
            }
            return stars;
        };


        // Função renderGallery
        const renderGallery = (photosToRender, containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return; 

            container.innerHTML = '';
            
            if (photosToRender.length === 0) {
                container.innerHTML = `
                    <div class="col-span-1 sm:col-span-2 lg:col-span-3 xl:col-span-4 text-center py-20">
                        <p class="text-xl text-gray-500">Nenhum projeto encontrado nesta categoria.</p>
                        <p class="text-gray-400 mt-2">Verifique o campo 'Tipo de Projeto' no painel de administração.</p>
                    </div>
                `;
            } else {
                photosToRender.forEach(projeto => {
                    const photoCard = document.createElement('div');
                    photoCard.setAttribute('data-project-id', projeto.id);
                    photoCard.classList.add('bg-white', 'rounded-lg', 'shadow-xl', 'p-4', 'flex', 'flex-col', 'items-center', 'space-y-2', 'cursor-pointer', 'transform', 'hover:scale-[1.03]', 'transition-all');
                    
                    photoCard.onclick = (e) => window.showModalFromCard(e);

                    const previewImage = projeto.images && projeto.images.length > 0 ? projeto.images[0].url : 'https://placehold.co/600x400/0095f6/ffffff?text=Sem+Imagem';
                    const rating = projeto.ratingCount > 0 ? projeto.totalRating / projeto.ratingCount : 0;
                    const displayStars = generateDisplayStars(rating);

                    photoCard.innerHTML = `
                        <div class="w-full h-32 bg-gray-200 rounded-md overflow-hidden">
                            <img src="${previewImage}" alt="Preview do projeto" class="w-full h-full object-cover">
                        </div>
                        <p class="font-bold text-lg text-gray-800 text-center">${projeto.tipoProjeto || 'Tipo Indefinido'}</p>
                        <p class="text-sm text-gray-600 text-center">${projeto.listaComodos ? projeto.listaComodos.length : 0} Cômodo(s)</p>
                        <div class="flex items-center space-x-1">${displayStars}</div>
                        `;
                    container.appendChild(photoCard);
                });
            }
        };

        // --- LISTENERS FIREBASE ---

        const setupFilteredGalleryListener = () => {
            const projectsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`);
            
            const q = query(
                projectsCollectionRef, 
                where('tipoProjeto', 'in', [
                    'Residencial - Interiores', 
                    'Comercial - Interiores', 
                    'Residencial - Arquitetônico', 
                    'Comercial - Arquitetônico'
                ]) 
            );

            onSnapshot(q, (querySnapshot) => {
                const filteredPhotos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGallery(filteredPhotos, 'gallery-arq-int'); 
            }, (error) => {
                console.error("Erro no listener de snapshot da Galeria Filtrada:", error);
                showMessage('Erro ao carregar projetos filtrados.', 'error');
            });
        };

        // --- FUNÇÕES MODAL E CAROUSEL ---

        window.showModal = (projeto) => { 
            const modal = document.getElementById('modal');
            const projectDetailsDesktop = document.getElementById('project-details-desktop');
            const projectDetailsMobile = document.getElementById('project-details-mobile');
            // 'project-title' foi removido daqui para evitar o TypeError, o título agora é injetado no detailsHTML.
            
            currentCarouselPhotos = projeto.images || [];
            currentImageIndex = 0;
            window.showCarousel();
            // A linha projectTitle.textContent = ... foi removida daqui, resolvendo o TypeError.

            const rating = projeto.ratingCount > 0 ? projeto.totalRating / projeto.ratingCount : 0;
            const displayStars = generateDisplayStars(rating);
            const comodosList = formatComodosList(projeto.listaComodos);

            const detailsHTML = `
                <div class="p-4 space-y-4">
                    <h3 class="text-xl font-bold text-gray-100">${projeto.nomeProjeto || 'Projeto Sem Nome'}</h3>
                    <p class="text-indigo-400">${projeto.tipoProjeto || 'Tipo Indefinido'} - ${projeto.tipoImovel || 'Imóvel Indefinido'}</p>
                    <div class="flex items-center space-x-1">${displayStars}</div>
                    <p class="text-gray-300">Descrição: ${projeto.descricao || 'Nenhuma descrição fornecida.'}</p>
                    <p class="text-gray-300">Cômodos: ${comodosList}</p>
                    <div class="pt-4 border-t border-gray-700 space-y-3">
                        <p class="text-white font-semibold">Deixe seu feedback:</p>
                        
                        <div class="flex items-center space-x-2 text-white">
                            <span class="text-sm">Avaliar:</span>
                            ${[1, 2, 3, 4, 5].map(r => `
                                <button onclick="window.rateProject('${projeto.id}', ${r})" 
                                    class="text-xl hover:text-yellow-400 transition-colors focus:outline-none" 
                                    aria-label="Avaliar com ${r} estrelas">
                                    &#9733;
                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="flex items-center space-x-4 text-white">
                            <span class="text-sm">Reagir:</span>
                            <button onclick="window.reactToProject('${projeto.id}', 'like')" class="flex items-center space-x-1 hover:text-blue-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.017-.487-.05l-4.529-.675a2 2 0 01-1.25-1.554L5.34 9.488A2 2 0 017.21 8h4.017c.163 0 .326.017.487.05l4.529.675a2 2 0 011.25 1.554L18.66 14.512A2 2 0 0116.79 16h-4.017c-.163 0-.326-.017-.487-.05l-4.529-.675a2 2 0 01-1.25-1.554L9.34 11.512A2 2 0 0111.21 10h4.017z"></path></svg>
                                <span>Gostei (${projeto.reactions?.like || 0})</span>
                            </button>
                            <button onclick="window.reactToProject('${projeto.id}', 'love')" class="flex items-center space-x-1 hover:text-red-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-.318-.318z"></path></svg>
                                <span>Amei (${projeto.reactions?.love || 0})</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            projectDetailsDesktop.innerHTML = detailsHTML;
            projectDetailsMobile.innerHTML = detailsHTML; 

            modal.classList.remove('hidden');
        };
        
        window.closeModal = () => { 
            document.getElementById('modal').classList.add('hidden');
        };
        
        // Função que atualiza a imagem do carrossel
        window.showCarousel = () => { 
            const imgElement = document.getElementById('main-carousel-image');
            if (currentCarouselPhotos.length > 0) {
                const imgUrl = currentCarouselPhotos[currentImageIndex].url;
                imgElement.src = imgUrl;
            } else {
                imgElement.src = 'https://placehold.co/600x400/CCCCCC/000000?text=Sem+Imagens';
            }
        };
        
        window.prevImage = () => { 
            if (currentCarouselPhotos.length > 0) {
                currentImageIndex = (currentImageIndex - 1 + currentCarouselPhotos.length) % currentCarouselPhotos.length;
                window.showCarousel();
            }
        };
        
        window.nextImage = () => { 
            if (currentCarouselPhotos.length > 0) {
                currentImageIndex = (currentImageIndex + 1) % currentCarouselPhotos.length;
                window.showCarousel();
            }
        };
        
        // Função que busca o projeto no Firestore e chama o showModal
        window.showModalFromCard = async (event) => {
            let cardElement = event.target.closest('[data-project-id]');
            if (!cardElement) return;

            const projectId = cardElement.getAttribute('data-project-id');
            if (!projectId) return;

            try {
                const docRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`, projectId);
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const projeto = { id: docSnap.id, ...docSnap.data() };
                        window.showModal(projeto);
                        unsubscribe(); 
                    } else {
                        showMessage("Projeto não encontrado.", 'error');
                        unsubscribe();
                    }
                }, (error) => {
                    console.error("Erro ao buscar detalhes do projeto:", error);
                    showMessage('Erro ao carregar detalhes do projeto.', 'error');
                    unsubscribe();
                });

            } catch (e) {
                console.error("Erro ao buscar detalhes:", e);
                showMessage('Erro desconhecido ao carregar detalhes.', 'error');
            }
        };
        
        // --- FUNÇÕES DE FEEDBACK ---
        
        window.rateProject = (projectId, rating) => {
            window.saveProjectFeedback(projectId, 'rating', rating);
        };

        window.reactToProject = (projectId, reaction) => {
            window.saveProjectFeedback(projectId, 'reaction', reaction);
        };

        // --- FUNÇÃO FIREBASE PARA SALVAR FEEDBACK (VOTO ou REAÇÃO) ---
        const saveProjectFeedback = async (projectId, type, value) => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                 showMessage('Você precisa estar logado para dar feedback.', 'error');
                 return;
            }

            const projectRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`, projectId);
            const userRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/users`, auth.currentUser.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const projectDoc = await transaction.get(projectRef);
                    const userDoc = await transaction.get(userRef);

                    if (!projectDoc.exists()) {
                        throw "Projeto não existe!";
                    }
                    const projeto = projectDoc.data();
                    const userData = userDoc.data() || {};
                    const userFeedback = userData.feedback || {};

                    const newFeedback = { ...userFeedback };

                    if (type === 'rating') {
                        const oldRating = newFeedback[projectId]?.rating;
                        
                        let newTotalRating = projeto.totalRating || 0;
                        let newRatingCount = projeto.ratingCount || 0;

                        if (oldRating) {
                            newTotalRating -= oldRating;
                        } else {
                            newRatingCount += 1;
                        }
                        
                        newTotalRating += value;
                        
                        transaction.update(projectRef, {
                            totalRating: newTotalRating,
                            ratingCount: newRatingCount
                        });

                        newFeedback[projectId] = { ...(newFeedback[projectId] || {}), rating: value };
                        
                        showMessage('Avaliação enviada com sucesso!', 'success');
                    
                    } else if (type === 'reaction') {
                        const oldReaction = newFeedback[projectId]?.reaction;
                        const reactions = projeto.reactions || {};
                        let newReactions = { ...reactions };
                        
                        if (oldReaction && oldReaction !== value) {
                            newReactions[oldReaction] = (newReactions[oldReaction] || 1) - 1;
                            newReactions[value] = (newReactions[value] || 0) + 1;
                            
                        } else if (oldReaction === value) {
                            newReactions[value] = (newReactions[value] || 1) - 1;
                            delete newFeedback[projectId].reaction; 
                            showMessage('Reação removida.', 'info');
                        } else {
                            newReactions[value] = (newReactions[value] || 0) + 1;
                            newFeedback[projectId] = { ...(newFeedback[projectId] || {}), reaction: value };
                            showMessage(`Você reagiu com ${value}!`, 'success');
                        }
                        
                        const reactionsToSave = Object.keys(newReactions).reduce((acc, key) => {
                            if (newReactions[key] > 0) {
                                acc[key] = newReactions[key];
                            }
                            return acc;
                        }, {});

                        transaction.update(projectRef, { reactions: reactionsToSave });
                    }

                    transaction.set(userRef, { feedback: newFeedback }, { merge: true });
                });

            } catch (e) {
                console.error("Erro na transação de feedback:", e);
                showMessage('Ocorreu um erro ao processar seu feedback.', 'error');
            }
        };
        
    </script>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="message-box" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 p-3 rounded-lg shadow-xl text-white font-semibold opacity-0 hidden transition-opacity duration-500" role="alert"></div>

    <div class="container mx-auto p-4 sm:p-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">Portfólio de Projetos</h1>

        <section class="mb-12">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Projetos Arq. e Int.</h2>
            <div id="gallery-arq-int" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div class="col-span-full text-center py-10 text-gray-500">Carregando projetos...</div>
            </div>
        </section>

        <div id="modal" onclick="if (event.target.id === 'modal') window.closeModal()" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-40 hidden flex items-center justify-center p-4 transition-opacity duration-300" role="dialog" aria-modal="true">
            <div class="bg-gray-800 rounded-lg shadow-2xl max-w-7xl w-full h-full lg:h-auto lg:max-h-[95vh] flex flex-col lg:flex-row relative overflow-hidden">
                <button onclick="window.closeModal()" class="absolute top-2 right-2 z-50 p-2 rounded-full bg-gray-900 text-white hover:bg-gray-700 transition-colors focus:outline-none" aria-label="Fechar Modal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>

                <div class="w-full lg:w-3/5 relative flex items-center justify-center bg-gray-900 p-2 sm:p-4 lg:p-0">
                    <div id="carousel-area" class="w-full h-full flex items-center justify-center mb-4">
                        
                        <button onclick="window.prevImage()" aria-label="Imagem Anterior" class="absolute left-0 lg:left-4 z-20 p-3 rounded-full bg-gray-900 bg-opacity-50 text-white hover:bg-opacity-75 transition-colors focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>

                        <img id="main-carousel-image" src="" alt="Imagem Principal" class="max-w-full h-auto max-h-[90vh] object-contain rounded-lg">
                        
                        <button onclick="window.nextImage()" aria-label="Próxima Imagem" class="absolute right-0 lg:right-4 z-20 p-3 rounded-full bg-gray-900 bg-opacity-50 text-white hover:bg-opacity-75 transition-colors focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="project-details-desktop" class="hidden lg:block lg:w-2/5 bg-gray-800 p-6 overflow-y-auto">
                    </div>
                
                <div id="project-details-mobile" class="lg:hidden bg-gray-800 bg-opacity-75 w-full p-3 overflow-y-auto max-h-[50vh]">
                    </div>
            </div>
        </div>
    </div>
</body>
</html>